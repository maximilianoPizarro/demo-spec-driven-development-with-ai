schemaVersion: 2.3.0
metadata:
  name: demo-spec-driven-development-with-ai
attributes:
  controller.devfile.io/storage-type: ephemeral  
components:
  - name: tools
    container:
      image: quay.io/che-incubator/cli-ai-tools:latest
      memoryLimit: 10G
      memoryRequest: 2G
      cpuRequest: 1000m
      cpuLimit: 5000m
      volumeMounts:
        - name: completions
          path: /mnt/data/completions
        - name: confd
          path: /mnt/data/conf.d
        - name: functions
          path: /mnt/data/functions
      env:
        - name: RA_AID_PROVIDER
          value: ollama
        - name: RA_AID_MODEL
          value: llama3:8b-instruct-q4_0
        - name: RA_AID_BACKEND
          value: ollama
        - name: RA_AID_HOST
          value: http://ollama:11434          
        - name: OLLAMA_API_BASE
          value: http://localhost:11434
        - name: DEVSPACES_API_KEY
          value: ZGV2c3BhY2Vz          
  - name: ollama
    attributes:
      container-overrides:
        resources:
          limits:
            cpu: 4000m
            memory: 12Gi
            # nvidia.com/gpu: 1 # Uncomment this if the pod shall be scheduled only on a GPU node
          requests:
            cpu: 1000m
            memory: 8Gi
            # nvidia.com/gpu: 1 # Uncomment this if the pod shall be scheduled only on a GPU node
    container:
      image: docker.io/ollama/ollama:latest
      mountSources: true
      sourceMapping: /.ollama
  - name: completions
    volume:
      size: 512Mi
  - name: confd
    volume:
      size: 512Mi
  - name: functions
    volume:
      size: 512Mi      
commands:
  - id: pullmodel
    exec:
      component: ollama
      commandLine: "ollama pull llama3:8b-instruct-q4_0"
  - id: oc-add-secret
    exec:
      label: 'OpenShift apply secret (OpenShift cluster)'
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: 'oc apply -f secret.yaml'
  - id: ra-aid-gen-spec
    exec:
      label: 'RA Aid gen with spec'
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: 'ra-aid --use-aider --cowboy-mode --show-cost --track-cost --msg-file spec.md'     
events:
  postStart:
    - oc-add-secret  
    - pullmodel     
